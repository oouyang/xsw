# DevContainer Refactoring - February 2, 2026

## Summary

Refactored the devcontainer configuration from a frontend-only setup (eps_padlog_frontend) to a full-stack development environment for the XSW (看小說) project, supporting both Python backend and Node.js frontend development.

## Key Changes

### 1. Project Renamed
- **Before**: `eps_padlog_frontend` (incorrect project name)
- **After**: `xsw-fullstack` (matches actual project)

### 2. Base Image Changed
- **Before**: `mcr.microsoft.com/devcontainers/typescript-node:18`
- **After**: `mcr.microsoft.com/devcontainers/python:3.11`
- **Reason**: Project needs Python 3.11 as the primary language for FastAPI backend

### 3. Node.js Added to Python Base
- Installed Node.js 20 LTS via NodeSource repository
- Enabled corepack for yarn/pnpm management
- Both Python and Node.js now available in same container

### 4. User Changed
- **Before**: `node` user (from typescript-node base image)
- **After**: `vscode` user (from python base image)
- **Impact**: All volume mounts and file paths updated accordingly

### 5. Ports Updated
- **Before**: Only port 5173 (Vite dev server)
- **After**:
  - Port 9000: Quasar dev server (frontend)
  - Port 8000: FastAPI backend (API)
- **Reason**: Project uses Quasar (not plain Vite) and needs backend API access

### 6. VS Code Extensions Added

#### Python Development
- `ms-python.python` - Python IntelliSense
- `ms-python.vscode-pylance` - Fast Python language server
- `charliermarsh.ruff` - Modern Python linter and formatter

#### Additional Tools
- `ms-azuretools.vscode-docker` - Docker management
- `humao.rest-client` - API testing within VS Code

#### Kept from Original
- Vue.volar, Vue.vscode-typescript-vue-plugin
- esbenp.prettier-vscode, dbaeumer.vscode-eslint
- antfu.goto-alias, usernamehw.errorlens, eamodio.gitlens

### 7. Python Environment Variables Added
```json
{
  "PYTHONUNBUFFERED": "1",          // Immediate stdout/stderr output
  "PYTHONDONTWRITEBYTECODE": "1"    // Prevent .pyc file creation
}
```

### 8. System Packages Added
- **SQLite3**: Command-line tools for database inspection
- **build-essential**: C compiler for Python packages with native extensions
- **python3-dev**: Python development headers

### 9. Persistent Volumes Updated

#### Added
- `xsw-pip-cache` - Python package cache
- `xsw-ruff-cache` - Ruff linter cache
- `xsw-data` - SQLite database and application data

#### Renamed (prefix changed)
- `eps-padlog-*` → `xsw-*` for all volumes

### 10. postCreate.sh Completely Rewritten

#### New Structure
1. **Python Backend Setup** (new)
   - Verify Python installation
   - Install dependencies from requirements.txt
   - Verify FastAPI and Uvicorn
   - Create data/ directory for SQLite

2. **Node.js Frontend Setup** (updated)
   - Enable corepack and activate yarn
   - Install dependencies from package.json/yarn.lock
   - Verify TypeScript and Quasar (not just TypeScript)

3. **Helpful Output** (enhanced)
   - Backend commands (uvicorn, python)
   - Frontend commands (npm run dev, build, lint, format)
   - Database commands (sqlite3)
   - Dev server URLs with correct ports

### 11. VS Code Python Settings Added
```json
{
  "[python]": {
    "editor.defaultFormatter": "charliermarsh.ruff",
    "editor.formatOnSave": true,
    "editor.codeActionsOnSave": {
      "source.fixAll": "explicit",
      "source.organizeImports": "explicit"
    }
  },
  "python.defaultInterpreterPath": "/usr/local/bin/python",
  "python.linting.enabled": true,
  "python.linting.ruffEnabled": true
}
```

### 12. README Completely Rewritten
- Project overview section for XSW
- Separate backend and frontend quick start guides
- Database operations section
- Full-stack development workflow
- Project-specific notes (authentication, caching, sync scripts)
- Troubleshooting for both Python and Node.js issues

## What Stayed the Same

### Security & Networking
- Corporate proxy configuration unchanged
- Micron CA certificates installation unchanged
- SSL/TLS environment variables unchanged
- No SSL verification disabled (security best practice maintained)

### Core Features
- Docker CLI installation for remote daemon access
- 2GB shared memory for browser testing
- Persistent volume caching strategy
- Proxy support for both build-time and runtime

## Migration Impact

### For Existing Devcontainer Users

**Breaking Changes:**
1. ⚠️ User changed from `node` to `vscode` - file ownership may need adjustment
2. ⚠️ Volume names changed - existing caches won't be reused (will rebuild)
3. ⚠️ Base image changed - full rebuild required

**Action Required:**
1. Close any existing devcontainer instances
2. Delete old volumes if needed: `docker volume prune`
3. Rebuild devcontainer: "Dev Containers: Rebuild Container"

**Estimated Rebuild Time:**
- First build: 10-15 minutes (download base image, install packages)
- With cache: 3-5 minutes
- postCreate.sh: 2-3 minutes (install dependencies)

### For New Users

No migration needed. Simply:
1. Open project in VS Code
2. "Dev Containers: Reopen in Container"
3. Wait for setup to complete
4. Start developing!

## File Changes Summary

| File | Change Type | Lines Changed |
|------|-------------|---------------|
| `.devcontainer/devcontainer.json` | Major refactor | ~150 lines |
| `.devcontainer/Dockerfile` | Major refactor | ~120 lines |
| `.devcontainer/library-scripts/postCreate.sh` | Complete rewrite | ~110 lines |
| `.devcontainer/library-scripts/install.sh` | Unchanged | 0 |
| `.devcontainer/README.md` | Complete rewrite | ~590 lines |
| `.devcontainer/CHANGES_2026-02-02.md` | Created | This file |

## Verification Checklist

After rebuilding the devcontainer, verify:

### Python Backend
- [ ] `python3 --version` shows Python 3.11.x
- [ ] `python3 -c "import fastapi, uvicorn"` succeeds
- [ ] `uvicorn main_optimized:app --reload` starts without errors
- [ ] http://localhost:8000/xsw/api/docs loads (FastAPI docs)

### Node.js Frontend
- [ ] `node --version` shows Node.js 20.x
- [ ] `yarn --version` succeeds
- [ ] `npm run dev` starts Quasar dev server
- [ ] http://localhost:9000 loads (Vue app)

### Database
- [ ] `data/` directory exists
- [ ] `sqlite3 --version` succeeds
- [ ] Database file created after backend starts

### VS Code
- [ ] Python extension active (bottom-left status bar shows Python 3.11)
- [ ] Ruff extension active (Format Document uses Ruff)
- [ ] Vue Volar extension active (.vue files have syntax highlighting)
- [ ] Both ports (8000, 9000) show in Ports panel when servers run

### SSL/TLS
- [ ] `echo $REQUESTS_CA_BUNDLE` shows CA bundle path
- [ ] `echo $NODE_EXTRA_CA_CERTS` shows CA bundle path
- [ ] `pip install` works without SSL errors
- [ ] `npm install` works without SSL errors

## Benefits of New Configuration

### Development Experience
1. **Single Environment**: No need to switch between Python and Node containers
2. **Hot Reload**: Both backend and frontend support live reload
3. **Integrated Testing**: Can test API + frontend together
4. **Database Access**: SQLite tools built-in for quick queries

### Performance
1. **Persistent Caches**: Faster rebuilds with pip and npm caches
2. **Volume Mounts**: Data survives container rebuilds
3. **Parallel Installs**: Both pip and yarn use parallel downloads

### Code Quality
1. **Auto-formatting**: Format on save for both Python and TypeScript
2. **Linting**: Real-time error detection with Error Lens
3. **Type Checking**: TypeScript + Python type hints validated
4. **API Testing**: REST Client extension for quick API calls

## Known Issues & Limitations

### Issue 1: First Build Slow
- **Impact**: First build takes 10-15 minutes
- **Workaround**: This is normal for base image download and package installation
- **Future**: Subsequent rebuilds use cached layers (much faster)

### Issue 2: Volume Mount Permissions
- **Impact**: Files created in container may have wrong ownership
- **Workaround**: Use `vscode` user consistently (already configured)
- **Future**: No action needed if using official devcontainer

### Issue 3: Large Image Size
- **Impact**: Final image ~2-3GB (Python + Node.js + dependencies)
- **Workaround**: This is expected for full-stack dev environment
- **Future**: Use volume mounts for dependencies (already done)

## Future Improvements

### Potential Enhancements
1. **Pre-built Image**: Publish pre-built devcontainer image to registry
2. **Multi-stage Build**: Separate build and runtime dependencies
3. **Playwright Support**: Add if E2E testing needed
4. **Database Migrations**: Add Alembic for schema migrations
5. **Redis Cache**: Optional Redis container for advanced caching

### Not Recommended
- ❌ Splitting into separate backend/frontend containers (defeats single-env purpose)
- ❌ Disabling SSL verification (security risk)
- ❌ Running as root user (security risk)

## Questions & Support

### Common Questions

**Q: Why Python base image instead of Node.js?**
A: The backend (FastAPI) is the primary application. Frontend is built and served by the backend in production.

**Q: Can I use a different Python version?**
A: Yes, edit Dockerfile line 3: `FROM mcr.microsoft.com/devcontainers/python:3.12`

**Q: Can I use npm instead of yarn?**
A: Yes, just delete `yarn.lock` and use `npm install`. The postCreate.sh script detects this automatically.

**Q: Do I need the Docker CLI tools?**
A: Only if you want to manage remote Docker hosts. Comment out `DOCKER_HOST` in devcontainer.json if not needed.

**Q: How do I update dependencies?**
A: Python: `pip install --user -r requirements.txt`. Node.js: `yarn install` or `npm install`.

### Getting Help

1. Check `.devcontainer/README.md` for detailed documentation
2. Check troubleshooting section for common issues
3. Verify environment variables are set correctly
4. Check VS Code output panel for build errors
5. Rebuild without cache if issues persist

## References

- [DevContainer Specification](https://containers.dev/)
- [Microsoft DevContainer Images](https://github.com/devcontainers/images)
- [FastAPI Best Practices](https://fastapi.tiangolo.com/deployment/docker/)
- [Quasar Framework](https://quasar.dev/start/vite-plugin)
- [VS Code Remote Development](https://code.visualstudio.com/docs/remote/remote-overview)

---

**Last Updated**: February 2, 2026
**Author**: Claude Code Assistant
**Project**: XSW (看小說) - Chinese Novel Reading Platform
