dhost=boleai02
dpath=/ci/apps/xeus/ws
dname=web
xhost=bolezk03
ximg=hpctw-docker-dev-local.boartifactory.micron.com/xsw
xpath=/etl/python_env

# Frontend build
alias build="nvm use 22 && QUASAR_STAGING=1 npm run build -- --debug"

# Frontend deploy - deploy SPA to nginx container
alias deploy="
echo 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”' && \
echo 'ğŸ“¦ [1/4] Creating tarball from dist/spa...' && \
tar czf dist/spa.tgz --transform='s|^dist/spa||' dist/spa/ && \
echo 'âœ“ Tarball created' && \
echo '' && \
echo 'â¬†ï¸  [2/4] Uploading to ${dhost}:${dpath}...' && \
scp -q dist/spa.tgz ${dhost}:${dpath} && \
echo 'âœ“ Upload complete' && \
echo '' && \
echo 'ğŸ“‹ [3/4] Copying to container ${dname}:/tmp...' && \
ssh ${dhost} docker exec kind docker cp ${dpath}/spa.tgz ${dname}:/tmp && \
echo 'âœ“ Copied to container' && \
echo '' && \
echo 'ğŸ“‚ [4/4] Extracting to /usr/share/nginx/html...' && \
ssh ${dhost} docker exec kind docker exec ${dname} tar xzf /tmp/spa.tgz -C /usr/share/nginx/html && \
echo 'âœ“ Extraction complete' && \
echo '' && \
echo 'âœ… Frontend deployment successful!' && \
echo 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”'
"

alias xtest="npm run test -- --reporter=verbose && pytest -v"
alias xlint="npm run lint && ruff check --fix"
# Backend build
alias xbuild="docker compose -f compose.yml -f docker/build.yml build xsw"

# Backend deploy - deploy xsw backend container
alias xdeploy="
echo 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”' && \
echo 'ğŸ·ï¸  [1/6] Tagging image as ${ximg}:latest...' && \
docker tag oouyang/xsw:latest ${ximg}:latest && \
echo 'âœ“ Image tagged' && \
echo '' && \
echo 'â¬†ï¸  [2/6] Pushing to registry...' && \
docker push ${ximg}:latest && \
echo 'âœ“ Push complete' && \
echo '' && \
echo 'â¬‡ï¸  [3/6] Pulling on ${dhost}...' && \
ssh ${dhost} docker pull ${ximg} && \
echo 'âœ“ Pull complete on ${dhost}' && \
echo '' && \
echo 'ğŸ’¾ [4/6] Saving image on ${dhost} to ${xpath}/ximg.tgz...' && \
ssh ${dhost} docker save ${ximg} -o ${xpath}/ximg.tgz && \
echo 'âœ“ Image saved' && \
echo '' && \
echo 'ğŸ“¥ [5/6] Loading image on ${xhost}...' && \
ssh ${xhost} docker load -i ${xpath}/ximg.tgz && \
echo 'âœ“ Image loaded on ${xhost}' && \
echo '' && \
echo 'ğŸ”„ [6/6] Restarting xsw container on ${xhost}...' && \
ssh ${xhost} docker compose -f /opt/nginx/docker-compose.yml down xsw && \
ssh ${xhost} docker compose -f /opt/nginx/docker-compose.yml up -d xsw && \
echo 'âœ“ Container restarted' && \
echo '' && \
echo 'âœ… Backend deployment successful!' && \
echo 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”'
"
# Optimized aliases

# Deploy - optimized with silent tar, parallel compression, combined SSH commands
#alias deploy="tar czf dist/spa.tgz --transform='s|^dist/spa||' dist/spa/ && scp -C dist/spa.tgz ${dhost}:${dpath} && ssh ${dhost} 'docker exec kind docker cp ${dpath}/spa.tgz ${dname}:/tmp && docker exec kind docker exec ${dname} tar xzf /tmp/spa.tgz -C /usr/share/nginx/html && docker exec kind docker exec ${dname} rm /tmp/spa.tgz'"

# Docker build - use buildkit for better caching
# alias xbuild="DOCKER_BUILDKIT=1 docker compose -f compose.yml -f docker/build.yml build xsw"

# Docker deploy - optimized with image streaming instead of save/load
# alias xdeploy="docker tag oouyang/xsw:latest ${ximg}:latest && docker push ${ximg}:latest && ssh ${dhost} 'docker pull ${ximg}' && ssh ${xhost} 'docker pull ${ximg} && docker compose -f /opt/nginx/docker-compose.yml up -d --no-deps xsw'"

# Quick deploy (no rebuild)
# alias deploy-fast="tar czf dist/spa.tgz -C dist/spa . && scp -C dist/spa.tgz ${dhost}:${dpath} && ssh ${dhost} 'docker exec kind docker cp ${dpath}/spa.tgz ${dname}:/tmp && docker exec kind docker exec ${dname} sh -c \"rm -rf /usr/share/nginx/html/* && tar xzf /tmp/spa.tgz -C /usr/share/nginx/html && rm /tmp/spa.tgz\"'"

# pgit: export a repo as bare tarball, copy to remote, extract into container, clone, set remote, push branch
pgit() {
  set -euo pipefail

  # --- Tunables via env vars ---
  local PRJ="${PRJ:-simbridge}"                 # project/repo name
  local BRANCH="${BRANCH:-master}"              # branch to push
  local SRC_REPO="${SRC_REPO:-/opt/ws/${PRJ}}"  # local source repo path
  local DST_HOST="${DST_HOST:-boleai02}"        # ssh host
  local DST_DIR="${DST_DIR:-/ci/tmp/aaaa}"      # directory on remote host (and visible in container)
  local CTR="${CTR:-kind}"                      # docker container name on remote host
  local GIT_URL="${GIT_URL:-https://github.com/alaska-icy-giant/${PRJ}.git}"  # remote git url to push to

  # --- Derived names (avoid collisions) ---
  local ts
  ts="$(date +%Y%m%d-%H%M%S)"
  local workdir
  workdir="$(mktemp -d "/tmp/${PRJ}.pgit.${ts}.XXXX")"
  local bare_dir="${workdir}/${PRJ}.git"
  local tarball="${workdir}/${PRJ}-git.${ts}.txz"

  # --- Cleanup on exit ---
  cleanup() { rm -rf "${workdir}"; }
  trap cleanup EXIT

  echo "[pgit] PRJ=${PRJ} BRANCH=${BRANCH}"
  echo "[pgit] SRC_REPO=${SRC_REPO}"
  echo "[pgit] DST_HOST=${DST_HOST} CTR=${CTR} DST_DIR=${DST_DIR}"
  echo "[pgit] GIT_URL=${GIT_URL}"

  # 1) Create bare clone tarball locally
  git clone --bare "${SRC_REPO}" "${bare_dir}"
  tar -C "${workdir}" -cvJf "${tarball}" "${PRJ}.git"

  # 2) Copy tarball to remote host
  ssh "${DST_HOST}" "mkdir -p '${DST_DIR}'"
  scp "${tarball}" "${DST_HOST}":"${DST_DIR}/"

  # 3) Extract tarball inside container into /tmp
  ssh "${DST_HOST}" "docker exec '${CTR}' mkdir -p /tmp"
  ssh "${DST_HOST}" "docker exec '${CTR}' tar -xvJf '${DST_DIR}/$(basename "${tarball}")' -C /tmp"

  # 4) Refresh destination workspace inside container and clone from bare repo
  ssh "${DST_HOST}" "docker exec -w '${DST_DIR}' '${CTR}' rm -rf '${DST_DIR:?}/${PRJ}'"
  ssh "${DST_HOST}" "docker exec -w '${DST_DIR}' '${CTR}' git clone '/tmp/${PRJ}.git' '${PRJ}'"

  # 5) Set remote & push branch
  ssh "${DST_HOST}" "docker exec -w '${DST_DIR}/${PRJ}' '${CTR}' git remote set-url origin '${GIT_URL}'"
  ssh "${DST_HOST}" "docker exec -w '${DST_DIR}/${PRJ}' '${CTR}' git push origin '${BRANCH}'"

  echo "[pgit] done âœ…"
}